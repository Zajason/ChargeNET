generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
// ---------- Enums ----------
enum Role {
  USER
  ADMIN
}

enum ChargerStatus {
  AVAILABLE
  IN_USE
  OUTAGE
}

enum ConnectorType {
  CCS
  CHADEMO // (avoid special characters; all caps is simplest)
  TYPE2
}

enum ReservationStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum SessionStatus {
  RUNNING
  COMPLETED
  AUTO_STOPPED
  USER_STOPPED
  INSUFFICIENT_FUNDS
}

enum PaymentStatus {
  PREAUTHORIZED
  CAPTURED
  CANCELLED
  FAILED
}

// ---------- Core ----------
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicles       Vehicle[]
  paymentMethods PaymentMethod[]
  reservations   Reservation[]
  sessions       Session[]
  invoices       Invoice[]
  paymentAuths   PaymentAuth[]
  auditEvents    AuditEvent[]
}

model Vehicle {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  make       String
  model      String
  batteryKWh Float
  maxKW      Float
  createdAt  DateTime @default(now())
}

// ---------- Catalog ----------
model Charger {
  id               Int             @id @default(autoincrement())
  name             String
  address          String?
  lat              Decimal         @db.Decimal(9, 6)
  lng              Decimal         @db.Decimal(9, 6)
  connectorType    ConnectorType
  maxKW            Float
  status           ChargerStatus   @default(AVAILABLE)
  pricingProfile   PricingProfile? @relation(fields: [pricingProfileId], references: [id])
  pricingProfileId Int?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  reservations Reservation[]
  sessions     Session[]

  @@index([status])
  @@index([lat, lng])
}

model PricingProfile {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  // JSON with your rule config: base, ToD windows, power tiers, wholesale multiplier, etc.
  rulesJson Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chargers Charger[]
}

// Wholesale market points (hourly)
model WholesalePricePoint {
  id             Int      @id @default(autoincrement())
  ts             DateTime @unique
  priceEurPerKWh Decimal  @db.Decimal(8, 5)
}

// ---------- User flows ----------
model Reservation {
  id        Int               @id @default(autoincrement())
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  charger   Charger           @relation(fields: [chargerId], references: [id], onDelete: Cascade)
  chargerId Int
  startsAt  DateTime
  expiresAt DateTime
  status    ReservationStatus @default(ACTIVE)
  createdAt DateTime          @default(now())

  session Session?
  // Ensure only one ACTIVE per charger overlapping in time handled in app/Redis;
  // you can still add a partial unique index later if needed.

  @@index([userId, status])
}

model Session {
  id            Int  @id @default(autoincrement())
  userId        Int
  chargerId     Int
  reservationId Int? @unique // <- add this

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  charger     Charger      @relation(fields: [chargerId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id])

  startedAt   DateTime
  endedAt     DateTime?
  kWh         Float         @default(0)
  avgKW       Float?
  pricePerKWh Decimal?      @db.Decimal(8, 5)
  costEur     Decimal?      @db.Decimal(10, 2)
  status      SessionStatus @default(RUNNING)
  createdAt   DateTime      @default(now())

  paymentAuth PaymentAuth?
  invoice     Invoice?
  auditEvents AuditEvent[]

  @@index([userId, status])
  @@index([chargerId, status])
}

model PaymentMethod {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  provider   String // e.g. "stripe", "mock"
  tokenLast4 String // masked details
  status     String // "valid" | "invalid" etc.
  createdAt  DateTime @default(now())

  @@index([userId])
}

model PaymentAuth {
  id          Int           @id @default(autoincrement())
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  session     Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId   Int           @unique
  amountEur   Decimal       @db.Decimal(10, 2)
  providerRef String?
  status      PaymentStatus
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Invoice {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId Int      @unique
  pdfUrl    String
  totalEur  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
}

// ---------- Integrations / audit ----------
model WebhookSubscription {
  id         Int            @id @default(autoincrement())
  url        String
  secret     String
  eventTypes String[] // e.g. ["CHARGER_STATUS_CHANGED","SESSION_STARTED"]
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  events     WebhookEvent[]
}

model WebhookEvent {
  id             Int                 @id @default(autoincrement())
  subscription   WebhookSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  subscriptionId Int
  type           String
  payloadJson    Json
  deliveryStatus String // PENDING|SENT|FAILED
  retries        Int                 @default(0)
  createdAt      DateTime            @default(now())
}

model AuditEvent {
  id         Int      @id @default(autoincrement())
  user       User?    @relation(fields: [userId], references: [id])
  userId     Int?
  entityType String // "Reservation" | "Session" | "Payment" | "System"
  entityId   Int?
  action     String // "CREATE" | "UPDATE" | "STOP" | "AUTO_STOP" ...
  metadata   Json?
  createdAt  DateTime @default(now())

  session   Session? @relation(fields: [sessionId], references: [id])
  sessionId Int?
}
